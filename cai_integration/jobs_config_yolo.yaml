# X-ray YOLO Detection Jobs Configuration
#
# This configuration defines the job sequence for YOLO-based X-ray detection on CAI:
# 1. setup_environment: Create Python venv and install dependencies (PyTorch, Ultralytics, etc.)
# 2. download_dataset: Download STCray dataset from HuggingFace
# 3. yolo_training: Convert data to YOLO format and train YOLO model
#
# Key Differences from VLM Approach:
# - No VQA generation needed (direct bbox training)
# - Much faster training (hours vs days)
# - Smaller model size (11-47MB vs 14GB)
# - Lower resource requirements (2-8GB VRAM vs 16GB+)
#
# Environment Variables:
# - FORCE_REINSTALL: Set to "true" to force full environment reinstall (default: "false")
# - MODEL_NAME: YOLO model variant (yolov8n, yolov8s, yolov8m, yolov11n, default: yolov8n.pt)
# - EPOCHS: Training epochs (default: 100)
# - BATCH_SIZE: Batch size (default: 16)
# - IMG_SIZE: Input image size (default: 640)
# - EXPORT_ONNX: Export to ONNX (default: false)
# - VAL_SPLIT: Validation split ratio (default: 0.2)
#
# Job Dependencies (handled automatically by CAI):
# - setup_environment (root) → download_dataset → yolo_training
# - When parent job succeeds, child jobs auto-trigger automatically

jobs:
  # Job 1: Setup Python Environment (ROOT JOB)
  setup_environment:
    name: "Setup Python Environment"
    description: "Create Python venv and install dependencies (PyTorch, Ultralytics YOLO, etc.)"
    script: "cai_integration/setup_environment.py"
    kernel: "python3"
    cpu: 4
    memory: 16
    timeout: 3600  # 1 hour for pip installs
    parent_job_key: null
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.10-standard:2025.09.1-b5"
    environment:
      FORCE_REINSTALL: "false"

  # Job 2a: Download Luggage X-ray Dataset (Optional - for luggage_xray dataset)
  download_luggage_xray:
    name: "Download Luggage X-ray Dataset"
    description: "Download Luggage X-ray dataset from Roboflow (7k images with 12 classes including 5 threats)"
    script: "cai_integration/download_luggage_xray.py"
    kernel: "python3"
    cpu: 4
    memory: 8
    timeout: 3600  # 1 hour for download
    parent_job_key: "setup_environment"
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.10-standard:2025.09.1-b5"

  # Job 2b: Download STCray Dataset (Optional - for stcray dataset)
  download_dataset:
    name: "Download STCray Dataset"
    description: "Download STCray dataset from HuggingFace (46k images with 21 threat categories)"
    script: "cai_integration/download_dataset.py"
    kernel: "python3"
    cpu: 4
    memory: 8
    timeout: 3600  # 1 hour for download
    parent_job_key: "setup_environment"
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.10-standard:2025.09.1-b5"

  # Job 3: YOLO Training
  # Supports multiple datasets: luggage_xray (recommended), cargoxray (quick), stcray (production)
  # Model selection: yolov8n (fastest), yolov8s (balanced), yolov8m (accurate), yolov11n (latest)
  # Early stopping: Training terminates if no mAP50 improvement for 10 consecutive epochs
  # Note: Requires shared memory configured in CAI project settings (10GB recommended for 8 workers)
  yolo_training:
    name: "Train YOLO Detection Model"
    description: "Train YOLO object detection model with early stopping (terminates after 10 epochs without improvement)"
    script: "cai_integration/yolo_training.py"
    kernel: "python3"
    cpu: 8  # 8 cores sufficient for YOLO training with GPU
    memory: 32  # 32GB sufficient with dedicated shared memory
    gpu: 1  # Single GPU is sufficient for YOLO training
    timeout: 14400  # 4 hours (increased for 200 epochs + yolov8x)
    parent_job_key: "download_luggage_xray"  # Updated by GitHub Actions based on dataset
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.10-cuda:2025.09.1-b5"
    environment:
      # Basic Configuration
      MODEL_NAME: "yolov8x.pt"  # yolov8n, yolov8s, yolov8m, yolov8x, yolov11n
      DATASET: "luggage_xray"  # luggage_xray (6,164 imgs), merged_xray (6,626 imgs), cargoxray, stcray
      EPOCHS: "200"  # Max epochs (early stop if no improvement)
      BATCH_SIZE: "8"  # Batch size (8 for yolov8x, 16 for yolov8n/s/m)
      IMG_SIZE: "640"
      EXPORT_ONNX: "false"  # Set to "true" to export ONNX for production
      VAL_SPLIT: "0.2"
      
      # Hyperparameters (Optimized for mAP50>0.50)
      LEARNING_RATE: "0.002"  # Initial learning rate (0.002 for yolov8x, 0.01 for yolov8n)
      OPTIMIZER: "AdamW"  # Optimizer: SGD, Adam, AdamW (AdamW best for large models)
      PATIENCE: "10"  # Early stopping: terminate after N epochs without improvement
      WARMUP_EPOCHS: "5.0"  # Warmup epochs for gradual LR ramp-up
      
      # Augmentation Parameters (Moderate settings to prevent confusion)
      AUG_DEGREES: "10.0"  # Rotation augmentation in degrees (0-30, default: 10)
      AUG_TRANSLATE: "0.05"  # Translation augmentation (0-0.2, default: 0.05)
      AUG_SCALE: "0.3"  # Scale augmentation (0-1.0, default: 0.3)
      AUG_MOSAIC: "0.8"  # Mosaic augmentation probability (0-1.0, default: 0.8)
      AUG_MIXUP: "0.0"  # Mixup augmentation probability (0-1.0, default: 0.0)

  # Job 4: Deploy YOLO API as CAI Application
  # Creates a persistent API endpoint accessible at https://[subdomain].[cai-domain]
  deploy_yolo_application:
    name: "Deploy YOLO API Application"
    description: "Deploy trained YOLO model as persistent CAI Application with exposed endpoints"
    script: "cai_integration/deploy_yolo_application.py"
    kernel: "python3"
    cpu: 2
    memory: 8
    timeout: 1800  # 30 minutes
    parent_job_key: "yolo_training"
    runtime_identifier: "docker.repository.cloudera.com/cloudera/cdsw/ml-runtime-pbj-jupyterlab-python3.10-standard:2025.09.1-b5"
    environment:
      # CAI credentials (set in GitHub Secrets or CAI Environment Variables)
      CAI_API_KEY: "${CAI_API_KEY}"
      CAI_DOMAIN: "${CAI_DOMAIN}"
      CAI_PROJECT_NAME: "xray-scanning-model"  # Deploy to this project (matches setup_project.py)
      # Application configuration
      MODEL_PATH: ""  # Auto-detect latest trained model, or use pre-trained (e.g., "yolov8n.pt")
      APP_SUBDOMAIN: "xray-yolo-api"  # Custom subdomain (optional)
      USE_GPU: "true"  # Set to "false" for CPU-only deployment (slower but no GPU needed)

# Note: After deployment, the API will be available at:
# - Health Check:     https://xray-yolo-api.[cai-domain]/health
# - API Docs:         https://xray-yolo-api.[cai-domain]/docs
# - OpenAI API:       https://xray-yolo-api.[cai-domain]/v1/chat/completions
# - Direct Detection: https://xray-yolo-api.[cai-domain]/v1/detect
