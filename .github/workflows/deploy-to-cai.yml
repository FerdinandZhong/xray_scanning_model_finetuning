name: Deploy X-ray VQA to CAI

on:
  workflow_dispatch:
    inputs:
      vllm_endpoint:
        description: 'External vLLM server endpoint (e.g., http://server:8000/v1) - Optional: can configure in CAI later'
        required: false
        default: ''
        type: string
      force_reinstall:
        description: 'Force environment reinstall'
        required: false
        default: false
        type: boolean
      trigger_jobs:
        description: 'Automatically trigger pipeline after setup'
        required: false
        default: false
        type: boolean
      samples_per_image:
        description: 'VQA samples per image'
        required: false
        default: '3'
        type: string
      api_key:
        description: 'API key for OpenAI/Claude/authenticated vLLM (optional)'
        required: false
        default: ''
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check vLLM endpoint
        run: |
          echo "üîç Checking vLLM endpoint..."
          if [ -z "${{ github.event.inputs.vllm_endpoint }}" ]; then
            echo "‚ö†Ô∏è  Warning: vLLM endpoint not provided"
            echo "   Jobs will be created with placeholder endpoint"
            echo "   You must configure the endpoint in CAI before running jobs"
            echo "   Automatic job triggering will be skipped"
          else
            echo "‚úÖ vLLM endpoint provided: ${{ github.event.inputs.vllm_endpoint }}"
          fi

      - name: Validate configuration files
        run: |
          echo "üîç Validating configuration files..."
          # Check required files exist
          test -f cai_integration/jobs_config.yaml
          test -f cai_integration/create_jobs.py
          test -f cai_integration/trigger_jobs.py
          echo "‚úÖ Configuration files validated"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."
          pip install pyyaml
          python -c "import yaml; yaml.safe_load(open('cai_integration/jobs_config.yaml'))"
          echo "‚úÖ YAML syntax valid"

  setup-project:
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      project_id: ${{ steps.setup.outputs.project_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Setup CAI Project
        id: setup
        env:
          CML_HOST: ${{ secrets.CML_HOST }}
          CML_API_KEY: ${{ secrets.CML_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_PAT: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Setting up CAI project for X-ray VQA..."
          python cai_integration/setup_project.py
          PROJECT_ID=$(cat /tmp/project_id.txt)
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Project ID: $PROJECT_ID"

      - name: Create job summary
        if: always()
        run: |
          echo "## X-ray VQA Setup: Project" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project ID**: ${{ steps.setup.outputs.project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ github.event.inputs.vllm_endpoint }}" ]; then
            echo "‚ö†Ô∏è **Warning**: vLLM endpoint not provided - jobs will not be triggered" >> $GITHUB_STEP_SUMMARY
          fi

  create-jobs:
    needs: setup-project
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Update jobs config with parameters
        run: |
          echo "üìù Updating jobs_config.yaml with parameters..."
          python3 << 'PYTHON_SCRIPT'
          import yaml
          
          with open('cai_integration/jobs_config.yaml') as f:
              config = yaml.safe_load(f)
          
          # Set vLLM endpoint (use placeholder if not provided)
          vllm_endpoint = '${{ github.event.inputs.vllm_endpoint }}'
          if vllm_endpoint:
              config['jobs']['generate_vqa']['environment']['VLLM_API_BASE'] = vllm_endpoint
              print(f"‚úì vLLM endpoint configured: {vllm_endpoint}")
          else:
              config['jobs']['generate_vqa']['environment']['VLLM_API_BASE'] = 'CONFIGURE_IN_CAI_BEFORE_RUNNING'
              print("‚ö† vLLM endpoint not provided - using placeholder")
              print("  You MUST configure this in CAI before running the generate_vqa job")
          
          config['jobs']['generate_vqa']['environment']['SAMPLES_PER_IMAGE'] = '${{ github.event.inputs.samples_per_image }}'
          config['jobs']['generate_vqa']['environment']['API_KEY'] = '${{ github.event.inputs.api_key }}'
          config['jobs']['setup_environment']['environment']['FORCE_REINSTALL'] = 'true' if '${{ github.event.inputs.force_reinstall }}' == 'true' else 'false'
          
          with open('cai_integration/jobs_config.yaml', 'w') as f:
              yaml.dump(config, f, default_flow_style=False)
          PYTHON_SCRIPT
          echo "‚úÖ Configuration updated"

      - name: Create CAI Jobs
        env:
          CML_HOST: ${{ secrets.CML_HOST }}
          CML_API_KEY: ${{ secrets.CML_API_KEY }}
        run: |
          echo "üìã Creating CAI jobs for X-ray VQA pipeline..."
          python cai_integration/create_jobs.py --project-id ${{ needs.setup-project.outputs.project_id }}
          echo "‚úÖ Jobs created"

      - name: Create job summary
        if: always()
        run: |
          echo "## X-ray VQA Setup: Jobs" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ github.event.inputs.vllm_endpoint }}" ]; then
            echo "‚ö†Ô∏è **vLLM Endpoint**: Not provided (placeholder used)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Before running the VQA generation job in CAI:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to CAI UI ‚Üí Jobs ‚Üí generate_vqa" >> $GITHUB_STEP_SUMMARY
            echo "2. Edit job environment variables" >> $GITHUB_STEP_SUMMARY
            echo "3. Set VLLM_API_BASE to your actual vLLM server endpoint" >> $GITHUB_STEP_SUMMARY
            echo "4. Then trigger the job manually" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **vLLM Endpoint**: ${{ github.event.inputs.vllm_endpoint }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Force Reinstall**: ${{ github.event.inputs.force_reinstall }}" >> $GITHUB_STEP_SUMMARY
          echo "**Samples per Image**: ${{ github.event.inputs.samples_per_image }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Key**: ${{ github.event.inputs.api_key && '<configured>' || '<not provided>' }}" >> $GITHUB_STEP_SUMMARY

  trigger-pipeline:
    needs: [setup-project, create-jobs]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: |
      github.event.inputs.trigger_jobs == 'true' && 
      github.event.inputs.vllm_endpoint != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Trigger Pipeline
        env:
          CML_HOST: ${{ secrets.CML_HOST }}
          CML_API_KEY: ${{ secrets.CML_API_KEY }}
        run: |
          echo "üöÄ Triggering X-ray VQA pipeline..."
          echo "Note: This only triggers the root job (setup_environment)"
          echo "Child jobs will auto-trigger via CAI dependencies"
          python cai_integration/trigger_jobs.py \
            --project-id ${{ needs.setup-project.outputs.project_id }}
          echo "‚úÖ Pipeline triggered"

      - name: Create summary
        if: always()
        run: |
          echo "## X-ray VQA Pipeline Triggered" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor job execution in CAI UI: Jobs > Job Runs" >> $GITHUB_STEP_SUMMARY
          echo "2. Pipeline will take 11-19 hours to complete" >> $GITHUB_STEP_SUMMARY
          echo "3. Check logs for any errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Execution Order" >> $GITHUB_STEP_SUMMARY
          echo "- setup_environment (triggered now)" >> $GITHUB_STEP_SUMMARY
          echo "- download_dataset (auto-triggers after setup)" >> $GITHUB_STEP_SUMMARY
          echo "- generate_vqa (auto-triggers after download)" >> $GITHUB_STEP_SUMMARY
          echo "- finetune_model (auto-triggers after VQA generation)" >> $GITHUB_STEP_SUMMARY

  skip-trigger:
    needs: [setup-project, create-jobs]
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.trigger_jobs == 'true' && 
      github.event.inputs.vllm_endpoint == ''

    steps:
      - name: Warning message
        run: |
          echo "‚ö†Ô∏è Pipeline trigger skipped - vLLM endpoint not provided"
          echo ""
          echo "Jobs have been created but not triggered."
          echo "To run the pipeline:"
          echo "1. Configure vLLM_API_BASE in CAI UI"
          echo "2. Manually trigger the setup_environment job"

      - name: Create summary
        run: |
          echo "## Pipeline Trigger Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Reason**: vLLM endpoint not provided" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Steps Required" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to CAI UI ‚Üí Jobs ‚Üí generate_vqa" >> $GITHUB_STEP_SUMMARY
          echo "2. Edit environment variables" >> $GITHUB_STEP_SUMMARY
          echo "3. Set VLLM_API_BASE to your vLLM server endpoint" >> $GITHUB_STEP_SUMMARY
          echo "4. Go to Jobs ‚Üí setup_environment" >> $GITHUB_STEP_SUMMARY
          echo "5. Click 'Run' to start the pipeline" >> $GITHUB_STEP_SUMMARY
